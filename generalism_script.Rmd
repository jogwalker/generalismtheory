---
title: "Is generalism of fish macroparasites associated with parasite and/or host traits?"
author: "Josephine Walker"
date: "8 April 2016"
output: pdf_document
---

The aim of this document is to calculate measures of generalism from the fish database, and assess the distribution of generalism scores by parasite characteristics.

The data are from the Fish Parasite Ecology Database (http://www.esapubs.org/archive/ecol/E094/045/metadata.php) with crustacean parasites and parasite traits for all species added by Amy Ellison, Jo Cable and team

```{r,cache=TRUE,results="hide"}
# read in data & remove duplicates

library(dplyr,suppressPackageStartupMessages())
library(tidyr,suppressPackageStartupMessages())

# set working directory to data location
setwd("~/dat/generalismtheory")

dat <- read.csv("fishparas.csv",header=T)
dat$pname <- paste(dat$P_Genus,dat$P_species,sep="_")
dat$hp <- paste(dat$hname,dat$pname,sep="+")

# update levels for consistency
levels(dat$Host_stage) <- c("Both","Both","Definitive","Definitive","Intermediate","nd")
levels(dat$GEO) <- c(NA,"AFR","ANT","AUS","IND",NA,NA,"NEA","NEO","PAL",NA,NA)

# extract list of host-parasite associations & traits
# association traits: Host_stage, GEO
pairs <- dat %>% select(hname,pname) %>% distinct()

# clean Host_stage
pairs.t1 <- dat %>% select(hp,hname,pname,Host_stage) %>% distinct()
pairs.dup <- pairs.t1[duplicated(pairs.t1[,1:2]) | duplicated(pairs.t1[,1:2], fromLast=TRUE),] %>% arrange(hname,pname) # all doubles 

cleanHS <- function(d) {
  if(any(d$Host_stage=="nd")) {
    new <- as.character(d$Host_stage[d$Host_stage!="nd"])
    return(new)
  }
  if(any(d$Host_stage=="Both")) {return("Both")}
  if(any(d$Host_stage=="Intermediate") & any(d$Host_stage=="Definitive")) {return("Both")}
}

pairs.new <- pairs.dup %>% group_by(hname,pname) %>% do(newHS=cleanHS(.))
pairs.new$newHS <- as.character(pairs.new$newHS)
# put back together
pairs.t2 <- left_join(pairs.t1,pairs.new,by=c("hname","pname"))
pairs.t2$Host_stage[!is.na(pairs.t2$newHS)] <- pairs.t2$newHS[!is.na(pairs.t2$newHS)]
pairs.t <- distinct(pairs.t2)
pairs.t$newHS <- NULL

# come back to GEO
pairs.g1 <- dat %>% select(hp,hname,pname,GEO) %>% distinct()
pairs.g1$val <- 1
pairs.g2 <- spread(pairs.g1,key=GEO,value=val,fill=0)
pairs.traits <- inner_join(pairs.t,pairs.g2,by=c("hp","hname","pname"))
save(pairs.traits,file="pairs.traits.RData")


# extract list of parasite traits
levels(dat$Endoparasite) <- c("Both","Ecto","Endo","Endo",NA)
levels(dat$Gender) <- c("Dioecious","Hermaphrodite","Hermaphrodite",NA)
levels(dat$Complex) <- c(NA,NA,"No","Yes","Yes_No")
levels(dat$Sexual) <- c(NA,"Both",NA,"Sexual","Sexual","Sexual")
levels(dat$Reproduction)[1:2] <- c(NA,NA)
levels(dat$Host_no)[c(1,8)] <- c(NA,NA)
levels(dat$Environment_LHS)[1:2] <- c(NA,NA)
levels(dat$Env_mode) <- c(NA,"napp",NA,"Water","Water")
levels(dat$Motile_LHS) <- c(NA,NA,"No","Yes","Yes")
levels(dat$Vector) <- c(NA,NA,"No","No","Yes")
levels(dat$Trophic) <- c(NA,NA,NA,NA,"No","Yes")
levels(dat$Horizontal) <- c(NA,"Yes",NA,"Yes")

para <- dat %>% select(pname,Endoparasite,Gender,Complex,Sexual,Reproduction,Host_no,Environment_LHS,Env_mode,Motile_LHS,Vector,Trophic,Horizontal) %>% distinct() # distinct rows of parasite traits
para.dup <- para[duplicated(para$pname) | duplicated(para$pname,fromLast = TRUE),] %>% arrange(pname) # find duplicated parasites
write.csv(para.dup,file="para.dup.out.csv")


# merge back with new row as whole row replacing that parasite name

for(j in 2:ncol(para.dup)) {
  para.dup[,c(1,j)] %>% group_by(pname,colnames(j)) %>% clean
}


# para.dup2 <- para.dup %>% gather(key="characteristic",value="value",-pname,na.rm=FALSE)
# para.dup3 <- para.dup2[duplicated(para.dup2) | duplicated(para.dup2, fromLast=TRUE),] %>% arrange(pname)
# 
# para.dup3 <- para.dup2 %>% group_by(pname,characteristic) %>% do(cleanCol(.[]))
# 
cleanCol <- function(d) {
  ifelse(all(is.na(d)),return(NA),return(paste(d[complete.cases(d)],sep="+")))
}
# 
# 
# para.dup2 <- para.dup %>% group_by(pname) %>% summarize(cleanCol(.$Endoparasite))
# 
# 
# 
# para2[which(all(is.na(para2[,1:12])))]
# para.tax2 <- para2[duplicated(para2$pname) | duplicated(para2$pname, fromLast=TRUE),] %>% arrange(pname) # 93 doubles
# 
# 
# 
# anyDuplicated(para[,1:4])
# 
# 
# para.2 <- para %>% distinct()




# to clean data - should check list of parasite and host species as some spellings are very similar, are these really different species?
# also values in each characteristic column are not consistent, ie yes/Yes
names(dat.u)
levels(dat.u$Host_stage)
levels(dat.u$Host_stage)[5] <- "Intermediate"
levels(dat.u$Endoparasite)
levels(dat.u$Endoparasite)[4:6] <- "Endoparasite"
levels(dat.u$Gender)
levels(dat.u$Gender) <- c("","Dioecious","Dioecious","Hermaphrodite","Hermaphrodite","Hermaphrodite")
levels(dat.u$Complex.)
levels(dat.u$Complex.) <- c("","",NA,"Simple","Complex","Complex","Complex","Complex","Both")
levels(dat.u$Sexual.)
levels(dat.u$Sexual.) <- c("",NA,"Both","Both","Oviparous","Sexual","Sexual","Sexual")
levels(dat.u$Reproduction)
levels(dat.u$Reproduction) <- c("",NA,"Oviparous","Oviparous","Oviparous","Ovoviviparous","Ovoviviparous","Sexual","Viviparous") # sexual shouldn't be here?
levels(dat.u$Host_no.) # how should this be categorized?
levels(dat.u$Environment_LHS.)
levels(dat.u$Environment_LHS.) <- c("","No","Yes","Yes")
levels(dat.u$Env_mode.)
levels(dat.u$Env_mode.)[4:6] <- "Water" # how should this be categorized?
levels(dat.u$Motile_LHS.)
levels(dat.u$Motile_LHS.) <- c("","No","No","Yes","Yes")
levels(dat.u$Vector.) 
levels(dat.u$Vector.) <- c("","No","No","Yes")
levels(dat.u$Trophic.)
levels(dat.u$Trophic.) <- c("",NA,NA,"No","No","Yes","Yes")
levels(dat.u$Horizontal.) # Are these all "yes"?

## host taxa
levels(dat.u$H_O)
levels(dat.u$H_O)[15:17] <- "Characiformes"
levels(dat.u$H_O)[c(18,20,21)] <- "Cyprinodontiformes"
levels(dat.u$H_O)[26:27] <- "Gonorhynchiformes" 
levels(dat.u$H_O)[33:34] <- "Lepidosireniformes"
levels(dat.u$H_O)[46:47] <- "Perciformes"
# there are many more to be corrected at lower levels - indices will change if species are added so I won't do this now

```

Generalism of the parasites can be calculated in a variety of ways, and may take into account relative prevalence, abundance and/or relatedness between host species [Poulin & Mouillot 2003, 2005]. Other indices account for connectedness within a host-parasite network and may account for prevalence or abundance [Dormann].  

In this data set, we don't have information on number of parasites per host or on prevalence or study effort, only reported associations between hosts and parasites. As a result we calculate only:

* **Degree**: the number of host species a parasite is associated with
* **$S_{TD}$**: the average taxonomic distinctness of all host species used by a parasite species [Poulin & Mouillot 2003]: $$S_{TD}=2[s(s-1)]^{-1}\sum \sum_{i<j} \omega_{ij}$$

    $S_{TD}$ can only be calculated for parasites infecting more than one host species, those infecting one species are assigned a value of 1. In addition $VarS_{TD}$ can only be calculated for hosts infecting more than 2 host species:
$$VarS_{TD}=[s(s-1)]^{-1}\sum \sum_{i\neq j}\left (\omega_{ij}-S_{TD}  \right )^2$$
    But this is the same as: $$VarS_{TD}=2[s(s-1)]^{-1}\sum \sum_{i< j}\left (\omega_{ij}-S_{TD}  \right )^2$$





* Another method could use host phylogenetic distance (eg from time tree of life) instead of categorized phylogenies
    + Do we have data for all species?

```{r,cache=TRUE}
library(ape,suppressPackageStartupMessages())

tree <- read.tree("C:/Users/Josephine/Google Drive/Thesis/Chapter 3 (Community Ecology)/ch3 stuff/TimetreeOfLife2015.nwk")

H_bin <- paste(dat.u$H_Genus,dat.u$H_species,sep="_") %>% unique()

pruned.tree<-drop.tip(tree, setdiff(tree$tip.label, H_bin))

# calculate path distance between each species (this should be time since last common ancestor*2)
pathlength <- cophenetic.phylo(pruned.tree)

paste("number of host species in database:",length(H_bin),sep=" ")
paste("number of nodes in pruned tree:", length(pruned.tree$tip.label),sep=" ")


```


Divergence time data are only available for about a quarter of the host species in the fish database. 

How many parasite species only infect one host in the database?

```{r,cache=TRUE}
dat.u$P_bin <- paste(dat.u$P_Genus,dat.u$P_species,sep="_")
dat.u$H_bin <- paste(dat.u$H_Genus,dat.u$H_species,sep="_")
degree <- dat.u %>% group_by(P_bin) %>% summarize(degree=n_distinct(H_bin),P_Taxon=first(P_Taxon),Host_stage=first(Host_stage),Endoparasite=first(Endoparasite),Gender=first(Gender),Complex=first(Complex.),Sexual=first(Sexual.),Reproduction=first(Reproduction),Host_no=first(Host_no.),Environment_LHS=first(Environment_LHS.),Env_mode=first(Env_mode.),Motile_LHS=first(Motile_LHS.),Vector=first(Vector.),Trophic=first(Trophic.),Horizontal=first(Horizontal.))
sum(degree$degree == 1)/nrow(degree)
quantile(degree$degree)

hist(log(degree$degree))
```

Does degree vary by taxonomic group or other parasite characteristics?

```{r,cache=TRUE}
boxplot(log(degree$degree) ~ degree$Gender)
boxplot(log(degree$degree) ~ degree$Host_stage)
boxplot(log(degree$degree) ~ degree$Endoparasite)
boxplot(log(degree$degree) ~ degree$Complex)
boxplot(log(degree$degree) ~ degree$Sexual)
boxplot(log(degree$degree) ~ degree$Reproduction)
boxplot(log(degree$degree) ~ degree$Host_no)
boxplot(log(degree$degree) ~ degree$Environment_LHS)
boxplot(log(degree$degree) ~ degree$Env_mode)
boxplot(log(degree$degree) ~ degree$Motile_LHS)
boxplot(log(degree$degree) ~ degree$Vector)
boxplot(log(degree$degree) ~ degree$Trophic)
boxplot(log(degree$degree) ~ degree$Horizontal)
boxplot(log(degree$degree) ~ degree$P_Taxon)
```

Calculate S_TD using taxonomic distance from data

```{r,eval=FALSE}

# calculate distance between each pair of host species (omega_ij) - original reference suggests up to phylum, we only have up to order. I was going to match orders to class but google revealed some controversy so will have to come back to this - any good sources for fish taxonomy?
dat.u$H_Class <- ""
dat.u$H_Phylum <- "Chordata"

hosts <- dat.u %>% select(H_O,H_F,H_Genus,H_species,H_Phylum,H_Class) %>% distinct()
hosts$H_bin <- paste(hosts$H_Genus,hosts$H_species,sep="_")
sum(table(hosts$H_bin) > 1) # some aren't unique presumably due to differences in capitalization etc at higher levels - check this again after data cleaning
# for now select unique based on H_bin
hosts.u <- hosts %>% distinct(H_bin)

# # http://stackoverflow.com/questions/17171148/non-redundant-version-of-expand-grid
expand.grid.unique <- function(x, y, include.equals=FALSE)
{
    x <- unique(x)

    y <- unique(y)

    g <- function(i)
    {
        z <- setdiff(y, x[seq_len(i-include.equals)])

        if(length(z)) cbind(x[i], z, deparse.level=0)
    }

    do.call(rbind, lapply(seq_along(x), g))
}

# write function to calculate S_TD
# only congeneric hosts will have value 1, so call one species only value 0?

get.S_TD <- function(dat) {
  S_TD <- 0
  VarS_TD <- NA
  
  if(nrow(dat) > 1) {
    temp <- data.frame(expand.grid.unique(dat$H_bin,dat$H_bin))
    temp$genus <- 0
    temp$family <- 0
    temp$order <- 0
    temp$class <- 0
    temp$phylum <- 0
    
    for (i in 1:nrow(temp)) {
      temp2 <- rbind(dat[dat$H_bin == temp$X1[i],],dat[dat$H_bin == temp$X2[i],])
      temp$genus[i] <- as.numeric(identical(temp2$H_Genus[1],temp2$H_Genus[2]))
      temp$family[i] <- as.numeric(identical(temp2$H_F[1],temp2$H_F[2]))
      temp$order[i] <- as.numeric(identical(temp2$H_O[1],temp2$H_O[2]))
      temp$class[i] <- as.numeric(identical(temp2$H_Class[1],temp2$H_Class[2]))
      temp$phylum[i] <- as.numeric(identical(temp2$H_Phylum[1],temp2$H_Phylum[2]))
    }

    temp$omega <- with(temp, 6 - genus - family - order - class - phylum)

    S_TD <- 2*(sum(temp$omega))/(nrow(dat)*(nrow(dat)-1))
    temp$Var <- (temp$omega - S_TD)^2 
    #print(temp)
    VarS_TD <- 2*(sum(temp$Var))/(nrow(dat)*(nrow(dat)-1))
  }
  return(data.frame(S_TD=S_TD,VarS_TD=VarS_TD,degree=nrow(dat)))
  #return(paste(S_TD,VarS_TD,sep="@"))
}

dat.u$H_O <- as.character(dat.u$H_O)
dat.u$H_F <- as.character(dat.u$H_F)
dat.u$H_Genus <- as.character(dat.u$H_Genus)

#test <- dat.u[1:100,] %>% group_by(P_bin) %>% do(get.S_TD(.))
# sub <- index[which(is.infinite(index$S_TD)),1]
# test2 <- dat.u[dat.u$P_bin %in% sub$P_bin,] %>% group_by(P_bin) %>% do(get.S_TD(.))


index <- dat.u %>% group_by(P_bin) %>% do(get.S_TD(.)) %>% ungroup()
save(index,file="index.RData")

````

The triangular scatter of the index matches what was observed in Poulin & Mouillot 2003.

```{r,cache=TRUE}
load("index.RData")
plot(x=index$degree,y=index$S_TD)
plot(x=log10(index$degree),y=index$S_TD)

#boxplots by parasite characteristic
fulldat <- full_join(degree,index,by=c("P_bin","degree"))
# dim correct

boxplot(fulldat$S_TD ~ fulldat$Gender)
boxplot(fulldat$S_TD ~ fulldat$Host_stage)
boxplot(fulldat$S_TD ~ fulldat$Endoparasite)
boxplot(fulldat$S_TD ~ fulldat$Complex)
boxplot(fulldat$S_TD ~ fulldat$Sexual)
boxplot(fulldat$S_TD ~ fulldat$Reproduction)
boxplot(fulldat$S_TD ~ fulldat$Host_no)
boxplot(fulldat$S_TD ~ fulldat$Environment_LHS)
boxplot(fulldat$S_TD ~ fulldat$Env_mode)
boxplot(fulldat$S_TD ~ fulldat$Motile_LHS)
boxplot(fulldat$S_TD ~ fulldat$Vector)
boxplot(fulldat$S_TD ~ fulldat$Trophic)
boxplot(fulldat$S_TD ~ fulldat$Horizontal)
boxplot(fulldat$S_TD ~ fulldat$P_Taxon)


```


