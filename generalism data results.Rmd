---
title: "Generalism data results"
author: "Josephine Walker"
date: "30 May 2016"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(MASS)
```
## Summary of Metrics Calculated
Generalism, similar to diversity, can be measured in a number of ways. Poulin et al 2011 describe four facets of generalism: basic, phylogenetic, geographic, and ontogenetic. Basic metrics are calculated from numbers of hosts, phylogenetic metrics use genetic or taxonomic distances between hosts, geographic metrics look at specificity in space, and ontogenetic metrics look at specificity between life stages of the parasite. We don't expect these measures to be independent.

The nature of the data in the fish host-parasite database, which only includes associations and not abundances or prevalences, limits the metrics which we can calculate. In addition, due to only have information on fish hosts, we can't calculate an accurate measure of intermediate host specificity, so do not calculate ontogenetic measures. We have information on geography at a large regional scale, but only a small proportion of parasites have hosts in multiple locations - instead of calculating a geographic metric, we calculate basic and phylogenetic metrics both with and without parasite-host associations divided by geographic region.

The metrics we calculate are:

| Metric | Description | Facet | Source |
|--------|-------------|-----------|-------|
|degree  | number of hosts | basic | |
| SPD | mean pairwise phylogenetic distance between all hosts | phylogenetic | Poulin & Mouillot |
| Faith's PD | minimum total length of all the phylogenetic branches required to span all hosts on the phylogenetic tree | phylogenetic | Faith 1992 |
| PS | sum of pairwise phylogenetic distance between all hosts |phylogenetic | Poulin 2011 |


## Analysis Methods
The generalism metrics for each parasite species were compared to measures of host and parasite characteristics (Table 1 in main document) for which theoretical predictions were made. 

Metrics for parasites with direct or trophic life cycles were compared to summary measures (mean, maximum, standard deviation (SD), and coefficient of variation (CV)) of the maximum length reported for each of their hosts.  Note that SD and CV of the host length are only calculated for parasites with more than one host. Endoparasites and ectoparasites were assessed separately, with an additional categorical length measure used for ectoparasites, whereby the mean maximum length was divided into a categorical variable according to quartiles.

<!-- SPD is only calculated for parasites with more than one host. -->
<!-- Negative binomial generalized linear models (GLM) with log link functions were used for response variable degree, linear models were used for SPD.   -->
<!-- PD & PS -->
<!-- %%%%%%%%%%%%%%% -->

<!-- The effect of geographic range on parasites with a direct life cycle was calculated for ectoparasites only, due to the small number of endoparasites with a direct life cycle. As above, a linear model/ANOVA was used to assess the effect of geographical category on SPD and VarSPD, while a negative binomial GLM was used for degree. Regions were assessed as defined in Table 1 and also divided into two groups, where Antarctica, Nearctic, and Palearctic were assumed to be colder than Africa, Australia, Indopacific, and Neotropical regions. Some host-parasite associations were reported in more than one region, so for this analysis the generalism metrics were calculated separately for each region. -->

<!-- The binary parasite characteristics of complex life cycle and trophic transmission were compared to the parasite indices as above – using a linear model/t-test for SPD and VarSPD and a negative binomial GLM for degree. In this case, endo and ectoparasites are considered in the same analysis. -->

## Endoparasites & Host Body Size
Subset to parasites known to either have a direct life cycle or trophic transmission (exclude complex non-trophic and NA)

Clay's model predicts that there should be a positive correlation among parasites’ generalism index and both the maximum host body size and the mean or median body size across all host species. 

For some measures we do see a positive correlation, and in particular there is a strong positive correlation between the coefficient of variation of host length and the mean phylogenetic distance between hosts (SPD).

Many of the relationships are very non-linear. 


```{r maxl,echo=FALSE,warning=FALSE}
load("~/dat/generalismtheory/indices29maytraits.RData")
names(generalism.traits)[4:8] <- c("PS","SPD","sSPD","PD","degree")
generalism.traits$cvmaxL <- generalism.traits$sdMaxL/generalism.traits$meanMaxL
hp.endo <- generalism.traits %>% filter(Endoparasite =="Endo")

hp.endo2 <- hp.endo %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD)

# divide into quartiles
summean <- summary(hp.endo2$meanMaxL)
hp.endo2$mean.lcat <- 1
hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["1st Qu."]] <- 2
hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["Median"]] <- 3
hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["3rd Qu."]] <- 4

sumsd <- summary(hp.endo2$sdMaxL)
hp.endo2$sd.lcat <- 1
hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["1st Qu."]] <- 2
hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["Median"]] <- 3
hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["3rd Qu."]] <- 4

summax <- summary(hp.endo2$maxMaxL)
hp.endo2$max.lcat <- 1
hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["1st Qu."]] <- 2
hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["Median"]] <- 3
hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["3rd Qu."]] <- 4

sumcv <- summary(hp.endo2$cvmaxL)
hp.endo2$cv.lcat <- 1
hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["1st Qu."]] <- 2
hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["Median"]] <- 3
hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["3rd Qu."]] <- 4

endoDlong <- hp.endo2 %>% gather("index","value",c(4:7))
endoDlong1 <- endoDlong %>% gather("length_cat_measure","length_cat",c(13:16))
endoDlong2 <- endoDlong1 %>% gather("length_measure","length",c(9:12))

endoDlong2 %>% ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="lm")

# endoDlong2 %>% ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="loess")

endoDlong2 %>% ggplot(data=.,aes(x=as.factor(length_cat),y=value)) + geom_boxplot() + theme_bw() + facet_grid(index~length_cat_measure,scales="free") + ylab("index value")
```

```{r endoanalysis, echo=FALSE,eval=FALSE}

summary(glm.nb(data=hp.endo2,degree ~ cvmaxL)) # positive
summary(glm.nb(data=hp.endo2,degree ~ maxMaxL)) # positive
summary(glm.nb(data=hp.endo2,degree ~ meanMaxL)) # negative
summary(glm.nb(data=hp.endo2,degree ~ sdMaxL)) # positive

# log transform doesn't help
# summary(lm(data=hp.endo2,log(PD) ~ cvmaxL)) # positive
# summary(lm(data=hp.endo2,log(PD) ~ maxMaxL)) # positive
# summary(lm(data=hp.endo2,log(PD) ~ meanMaxL)) # negative
# summary(lm(data=hp.endo2,log(PD) ~ sdMaxL)) # positive
# 
# summary(glm.nb(data=hp.endo2,PS ~ cvmaxL)) # positive
# summary(glm.nb(data=hp.endo2,PS ~ maxMaxL)) # positive
# summary(glm.nb(data=hp.endo2,PS ~ meanMaxL)) # negative
# summary(glm.nb(data=hp.endo2,PS ~ sdMaxL)) # positive

summary(lm(data=hp.endo2,SPD ~ cvmaxL)) # positive
summary(lm(data=hp.endo2,SPD ~ maxMaxL)) # no relationship
summary(lm(data=hp.endo2,SPD ~ meanMaxL)) # negative
summary(lm(data=hp.endo2,SPD ~ sdMaxL)) # positive
```

## Ectoparasites & Host Body Size
Clay's model predicts that for ectoparasites, there should be few generalist parasites of either very small bodied or very large bodied hosts.

This seems to be the case for degree, PD, and PS, but not so clear for SPD. However, I categorized by quartiles and due to the skewed distribution and long tail, in some cases relatively low values for length are in the 4th quartile, for example for sd and max length. Mean length shows what we expect with quartile categorization. Is there a better way to categorize?  

```{r ecto, echo=FALSE,warning=FALSE}
hp.ecto <- generalism.traits %>% filter(Endoparasite =="Ecto")
hp.ecto2 <- hp.ecto %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD)

# divide into quartiles
summean <- summary(hp.ecto2$meanMaxL)
hp.ecto2$mean.lcat <- 1
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["1st Qu."]] <- 2
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["Median"]] <- 3
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["3rd Qu."]] <- 4

sumsd <- summary(hp.ecto2$sdMaxL)
hp.ecto2$sd.lcat <- 1
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["1st Qu."]] <- 2
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["Median"]] <- 3
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["3rd Qu."]] <- 4

summax <- summary(hp.ecto2$maxMaxL)
hp.ecto2$max.lcat <- 1
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["1st Qu."]] <- 2
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["Median"]] <- 3
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["3rd Qu."]] <- 4

sumcv <- summary(hp.ecto2$cvmaxL)
hp.ecto2$cv.lcat <- 1
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["1st Qu."]] <- 2
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["Median"]] <- 3
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["3rd Qu."]] <- 4

ectoDlong <- hp.ecto2 %>% gather("index","value",4:7)
ectoDlong1 <- ectoDlong %>% gather("length_cat_measure","length_cat",c(13:16))
ectoDlong2 <- ectoDlong1 %>% gather("length_measure","length",9:12)


ectoDlong2 %>%  ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="lm")

# ectoDlong2 %>%  ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="loess")

ectoDlong2 %>% ggplot(data=.,aes(x=as.factor(length_cat),y=value)) + geom_boxplot() + theme_bw() + facet_grid(index~length_cat_measure,scales="free") + ylab("index value")

```



```{r ectoanalysis, echo=FALSE,eval=FALSE}
# Negative binomial GLM seems like the best way to compare Ecto degree to quartiles of length categories. The estimates are log values, so exp() to get the estimate. Except, it's strictly positive so should use a zero truncated model?
summary(lm(data=hp.ecto2,cvmaxL~SPD))

summary(lm(data=hp.ectoDirect,maxMaxL~SPD))
summary(lm(data=hp.ectoDirect,maxMaxL~VarSPD))

summary(lm(data=hp.ectoDirect,meanMaxL~SPD))
summary(lm(data=hp.ectoDirect,meanMaxL~VarSPD))

summary(lm(data=hp.ectoDirect,sdMaxL~SPD))
summary(lm(data=hp.ectoDirect,sdMaxL~VarSPD))

# these LMs don't have straight Q-Q plots. Need to think about the implications.

library(MASS)
summary(glm.nb(data=hp.ectoDirect,degree ~ cvmaxL))
summary(glm.nb(data=hp.ectoDirect,degree ~ maxMaxL))
summary(glm.nb(data=hp.ectoDirect,degree ~ meanMaxL))
summary(glm.nb(data=hp.ecto2,degree ~ as.factor(mean.lcat)))

```

## Temperature (Region) and Generalism
Clay's model predicts that generalists are more likely in cooler temperatures. Our measure of temperature based on region here is very, very rough. We see higher degree in cool regions, but slightly lower phylogenetic generalism. Could this be because of confounding with available hosts and higher host diversity in warm regions?


```{r geo, echo=FALSE,warning=FALSE}
# Use alternative index calculated with GEO
load("~/dat/generalismtheory/indices29maytraits_GEO.RData")
names(generalism.traits.GEO)[5:9] <- c("PS","SPD","sSPD","PD","degree")
generalism.traits.GEO$cvmaxL <- generalism.traits.GEO$sdMaxL/generalism.traits.GEO$meanMaxL

hp.geoDirect <- generalism.traits.GEO %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD)

GeoDirectEcto <- hp.geoDirect %>% filter(Endoparasite=="Ecto")
GeoDirectEcto$GeoGroup <- NA
GeoDirectEcto$GeoGroup[GeoDirectEcto$GEO %in% c("AFR","AUS","IND","NEO")] <- "warm"
GeoDirectEcto$GeoGroup[GeoDirectEcto$GEO %in% c("ANT","NEA","PAL")] <- "cool"

geoDlong <- GeoDirectEcto %>% gather("index","value",5:8)
geoDlong %>% ggplot(data=.,aes(x=GEO,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free") 
geoDlong %>% ggplot(data=.,aes(x=GeoGroup,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free")

```




```{r geoanalysis, echo=FALSE,eval=FALSE}
summary(lm(data=GeoDirectEcto,SPD ~ GEO))

summary(glm.nb(data=GeoDirectEcto,degree ~ GEO))

summary(glm.nb(data=GeoDirectEcto,degree ~ GeoGroup))

summary(lm(data=GeoDirectEcto,SPD ~ GeoGroup))
summary(lm(data=GeoDirectEcto,PD ~ GeoGroup))

```

## Trophic Transmission
Amy  H's model predicts that parasites with trophic transmission are less likely to be generalists, but we see the opposite pattern in this data.

```{r trophic,echo=FALSE,warning=FALSE}
hp.trop <- generalism.traits %>% filter(Trophic == "Yes" | Trophic=="No") %>% dplyr::select(-sSPD)
troplong <- hp.trop %>% gather("index","value",4:7) 

troplong %>% ggplot(data=.,aes(x=Trophic,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free") 
```

```{r trophicanalysis, echo=FALSE,eval=FALSE}
summary(glm.nb(data=hp.trop,degree ~ Trophic)) # trophic higher - opposite of model predieciton
summary(lm(data=hp.trop,SPD ~ Trophic))

with(hp.def,table(Trophic,Complex))
# Trophic and Complex are almost perfectly correlated in this subset of the dataset.

```
