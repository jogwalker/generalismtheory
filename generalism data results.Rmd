---
title: "Generalism data results"
author: "Josephine Walker"
date: "30 May 2016"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(MASS)
setwd("~/dat/generalismtheory/")
```

```{r cleanmore,echo=FALSE,eval=FALSE}
load("dat.ph.drop.RData")
dat.ph.2 <- dat.ph.drop
dat.ph.2$Definitive <- 0
dat.ph.2$Definitive[dat.ph.2$Host_stage=="Definitive" | dat.ph.2$Host_stage=="Both"] <- 1
dat.ph.2$Intermediate <- 0
dat.ph.2$Intermediate[dat.ph.2$Host_stage=="Intermediate" | dat.ph.2$Host_stage=="Both"] <- 1
dat.ph.def <- dat.ph.2 %>% filter(Definitive==1)
# correct a few additional host names so they match phylogenetic data
dat.ph.def$new_hname <- as.character(dat.ph.def$new_hname)
# trinomials & nf....
dat.ph.def$new_hname[dat.ph.def$new_hname=="Capoetobrama kuschakewitschi kuschakewitsch"] <- "Capoetobrama kuschakewitschi" 
dat.ph.def$new_hname[dat.ph.def$new_hname=="Tylosurus acus melanotus"] <- "Tylosurus acus" 
dat.ph.def$new_hname[dat.ph.def$new_hname=="Esox americanus americanus"] <- "Esox americanus" 
dat.ph.def$new_hname[dat.ph.def$new_hname=="Salvelinus leucomaenis pluvius"] <- "Salvelinus leucomaenis"
dat.ph.def$new_hname[dat.ph.def$new_hname=="nf"] <- NA

# separate out parasite traits in order to correct some errors
par.traits <- dat.ph.def %>% dplyr::select(new_pname,P_Taxon,Endoparasite,Complex,Trophic,Horizontal,Host_no) %>%  filter(!is.na(new_pname))  %>% filter(!(new_pname=="Spiracanthus bovichthys" & P_Taxon=="M")) %>% filter(!(new_pname=="Neoechinorhynchus cylindratus" & P_Taxon=="M")) %>% arrange(new_pname,Endoparasite,Complex,Trophic,Horizontal) %>% distinct(new_pname)
par.traits$Complex[as.numeric(par.traits$Host_no) > 1 & par.traits$Complex=="No"] <- NA # factor level 1 is "1"
par.traits <- par.traits %>% dplyr::select(-Host_no)


###### assume global max host size as max host size
host.traits <- dat.ph.def %>% dplyr::select(MaxL,new_hname) %>% group_by(new_hname) %>% summarize(maxL=max(MaxL,na.rm=T))

# unique host parasite lists
bipdef <- dplyr::select(dat.ph.def,new_pname,new_hname) %>% distinct() %>% arrange(new_pname,new_hname) %>% filter(!(is.na(new_pname) | is.na(new_hname)))

bipdefgeo <- dplyr::select(dat.ph.def,new_pname,new_hname,GEO) %>% distinct() %>% arrange(new_pname,new_hname) %>% filter(!(is.na(new_pname) | is.na(new_hname)))

# regroup
bipdef.traits1 <- left_join(bipdef,host.traits,by=c("new_hname"))
bipdef.traits <- left_join(bipdef.traits1,par.traits,by=c("new_pname"))

bipdefgeo.traits1 <- left_join(bipdefgeo,host.traits,by=c("new_hname"))
bipdefgeo.traits <- left_join(bipdefgeo.traits1,par.traits,by=c("new_pname"))

save(bipdef.traits,bipdefgeo.traits,file="bipdeftraits30may.Rdata")
# these files are used for calculating the metrics

```

```{r metrics,echo=FALSE,eval=FALSE}

library(ape)
library(phangorn)
library(gdata)
library(picante)

load("bipdeftraits30may.Rdata")
load('pgd_final.RData') #matrix called pgd_final

############
# FUNCTIONS
###########

calcMetrics <- function(assoc,ro_allhost_tree,pgd_final,filename) {
  cdmat <- makecdmat(assoc)
  pd_allhost <- suppressWarnings(pd(cdmat,ro_allhost_tree,include.root=FALSE)) # exclude root 
  pd_allhost$new_pname <- rownames(pd_allhost)
  save(pd_allhost,file=paste("pd",filename,sep="_"))
  gen <- calcother(assoc,pgd_final)
  generalism <- full_join(gen,pd_allhost,by="new_pname")
  save(generalism,file=filename)
  return(generalism)
}

makecdmat <- function(assoc) {
  # make a community data matrix (which is just a binary matrix to record associations - parasites as rows and hosts as columns)
  paralist <- unique(assoc$new_pname)
  hostlist <- unique(assoc$h_name)
  cdmat<-matrix(rep(0,length(paralist)*length(hostlist)),nrow=length(paralist))
  colnames(cdmat)<-hostlist
  rownames(cdmat)<-paralist
  for(paras in 1:length(paralist)){
    hlist<-assoc[assoc$new_pname==paralist[paras],"h_name"]
    cdmat[paras,intersect(hlist, hostlist)]<-1
  }
  return(cdmat)
}


hlistsum <- function(hlist,pgd_final) {
  sumPGD<-sum(pgd_final[hlist, hlist], na.rm=TRUE) # only lower triangle
  return(as.numeric(sumPGD))
  #print(sumPGD)
}

calcother <- function(assoc,pgd_final) {
  
  gen <- assoc %>% group_by(new_pname,P_Taxon,Endoparasite,Complex,Trophic,Horizontal) %>% summarize(hostN=n(),edges=(n()*(n()-1))/2,meanMaxL=mean(maxL,na.rm=T),sdMaxL=sd(maxL,na.rm=T),maxMaxL=max(maxL,na.rm=T)) 
  
  gen2 <- assoc %>% dplyr::select(-maxL,-new_hname) %>% group_by(new_pname,P_Taxon,Endoparasite,Complex,Trophic,Horizontal) %>% do({
    sumPGD <- hlistsum(.$h_name,pgd_final)
    x <- .[1,]
    x$sumPGD <- sumPGD
    return(x)
  }) %>% dplyr::select(-h_name)
  
  gen3 <- full_join(gen,gen2,by=c("new_pname","P_Taxon","Endoparasite","Complex","Trophic","Horizontal"))
  gen3$cvmaxL <- gen3$sdMaxL/gen3$meanMaxL
  gen3$SPD <- gen3$sumPGD/gen3$edges
  gen3$G <- as.numeric(gen3$hostN > 1)

  return(gen3)
}





############
# Make tree
############
# make the tree of all hosts (ultrametric using upgma)
allhost_tree<-upgma(pgd_final)
# plot(allhost_tree, show.tip.label = FALSE, direction="downwards")
# plot(allhost_tree, show.tip.label = FALSE, type="fan")
ro_allhost_tree<-reorder(allhost_tree, "cladewise")

########################
# Calculate without GEO
########################
assoc <- bipdef.traits
assoc$h_name <- gsub(" ","_",assoc$new_hname)
#paralist <- as.character(unique(assoc$new_pname))
gen.noGEO <- calcMetrics(assoc,ro_allhost_tree,pgd_final,"gen.noGEO.RData")

########################
# Calculate with GEO
########################
assocG <- bipdefgeo.traits
assocG$h_name <- gsub(" ","_",assocG$new_hname)
assocG <- unite(assocG,new_pname,new_pname,GEO,sep="_",remove=TRUE) # need to make the pname + GEO
gen.GEO <- calcMetrics(assocG,ro_allhost_tree,pgd_final,"gen.GEO.RData")
#gen.GEO.s <- separate(gen.GEO,new_pname,"new_pname","GEO",sep="_",remove=TRUE)
# think about GEO NA's

```


## Summary of Metrics Calculated
Generalism, similar to diversity, can be measured in a number of ways. Poulin et al 2011 describe four facets of generalism: basic, phylogenetic, geographic, and ontogenetic. Basic metrics are calculated from numbers of hosts, phylogenetic metrics use genetic or taxonomic distances between hosts, geographic metrics look at specificity in space, and ontogenetic metrics look at specificity between life stages of the parasite. We don't expect these measures to be independent.

The nature of the data in the fish host-parasite database, which only includes associations and not abundances or prevalences, limits the metrics which we can calculate. In addition, due to only have information on fish hosts, we can't calculate an accurate measure of intermediate host specificity, so do not calculate ontogenetic measures. We have information on geography at a large regional scale, but only a small proportion of parasites have hosts in multiple locations - instead of calculating a geographic metric, we calculate basic and phylogenetic metrics both with and without parasite-host associations divided by geographic region.

The metrics we calculate are:

| Metric | Description | Facet | Source |
|--------|-------------|-----------|-------|
|degree  | number of hosts | basic | |
|G | binary measure, G=1 if degree > 1 | basic | |
| SPD | mean pairwise phylogenetic distance between all hosts | phylogenetic | Poulin & Mouillot |
| Faith's PD | minimum total length of all the phylogenetic branches required to span all hosts on the phylogenetic tree | phylogenetic | Faith 1992 |
<!-- | PS | sum of pairwise phylogenetic distance between all hosts |phylogenetic | Poulin 2011 | -->

Both phylogenetic metrics, SPD and Faith's PD, are only calculated for parasites with more than 1 host (G=1).

## Analysis Methods
The generalism metrics for each parasite species were compared to measures of host and parasite characteristics (Table 1 in main document) for which theoretical predictions were made. 

Metrics for parasites with direct or trophic life cycles were compared to summary measures (mean, maximum, and coefficient of variation (CV)) of the maximum length reported for each of their hosts.  Note that CV of the host length is only calculated for parasites with more than one host. Endoparasites and ectoparasites were assessed separately, with an additional categorical length measure used for ectoparasites, whereby the mean maximum length was divided into a categorical variable according to quartiles.

The effect of geographic region on parasites with direct or trophic life cycle was calculated for endoparasites and ectoparasites together. Regions were assessed as defined in Table 1 and also divided into two groups, where Antarctica, Nearctic, and Palearctic were assumed to be colder than Africa, Australia, Indopacific, and Neotropical regions. Some host-parasite associations were reported in more than one region, so for this analysis the generalism metrics were calculated separately for each region.

<!-- Negative binomial generalized linear models (GLM) with log link functions were used for response variable degree, linear models were used for SPD.   -->
<!-- PD & PS -->
<!-- %%%%%%%%%%%%%%% -->

<!-- TAs above, a linear model/ANOVA was used to assess the effect of geographical category on SPD and VarSPD, while a negative binomial GLM was used for degree.  -->

<!-- The binary parasite characteristics of complex life cycle and trophic transmission were compared to the parasite indices as above – using a linear model/t-test for SPD and VarSPD and a negative binomial GLM for degree. In this case, endo and ectoparasites are considered in the same analysis. -->

## Endoparasites & Host Body Size
Clay's model predicts that there should be a positive correlation among parasites’ generalism metrics and both the maximum host body size and the mean and CV body size across all host species. 

For some measures we do see a positive correlation, and in particular there is a strong positive correlation between the coefficient of variation of host length and the mean phylogenetic distance between hosts (SPD).

Many of the relationships appear to be non-linear, but this is driven by outliers. 


```{r maxl,echo=FALSE,warning=FALSE}
load("~/dat/generalismtheory/indices29maytraits.RData")
names(generalism.traits)[4:8] <- c("PS","SPD","sSPD","PD","degree")
generalism.traits$cvmaxL <- generalism.traits$sdMaxL/generalism.traits$meanMaxL
generalism.traits$G <- as.numeric(generalism.traits$degree > 1)
generalism.traits$PD[generalism.traits$G==0] <- NA

hp.endo <- generalism.traits %>% filter(Endoparasite =="Endo")
hp.endo2 <- hp.endo %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD,-PS,-sdMaxL)

# # divide into quartiles
# summean <- summary(hp.endo2$meanMaxL)
# hp.endo2$mean.lcat <- 1
# hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["1st Qu."]] <- 2
# hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["Median"]] <- 3
# hp.endo2$mean.lcat[hp.endo2$meanMaxL > summean["3rd Qu."]] <- 4
# 
# sumsd <- summary(hp.endo2$sdMaxL)
# hp.endo2$sd.lcat <- 1
# hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["1st Qu."]] <- 2
# hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["Median"]] <- 3
# hp.endo2$sd.lcat[hp.endo2$sdMaxL > sumsd["3rd Qu."]] <- 4
# 
# summax <- summary(hp.endo2$maxMaxL)
# hp.endo2$max.lcat <- 1
# hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["1st Qu."]] <- 2
# hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["Median"]] <- 3
# hp.endo2$max.lcat[hp.endo2$maxMaxL > summax["3rd Qu."]] <- 4
# 
# sumcv <- summary(hp.endo2$cvmaxL)
# hp.endo2$cv.lcat <- 1
# hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["1st Qu."]] <- 2
# hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["Median"]] <- 3
# hp.endo2$cv.lcat[hp.endo2$cvmaxL > sumcv["3rd Qu."]] <- 4

endoDlong <- hp.endo2 %>% gather("index","value",c(4:6,15))
#endoDlong1 <- endoDlong %>% gather("length_cat_measure","length_cat",c(13:16))
endoDlong2 <- endoDlong %>% gather("length_measure","length",c(9:11))

endoDlong2 %>% ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="lm")

# endoDlong2 %>% ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="loess")

endoDlong2 %>% ggplot(data=.,aes(x=as.factor(length_cat),y=value)) + geom_boxplot() + theme_bw() + facet_grid(index~length_cat_measure,scales="free") + ylab("index value")
```

```{r endoanalysis, echo=FALSE,eval=FALSE}

summary(glm.nb(data=hp.endo2,degree ~ cvmaxL)) # positive
summary(glm.nb(data=hp.endo2,degree ~ maxMaxL)) # positive
summary(glm.nb(data=hp.endo2,degree ~ meanMaxL)) # negative
summary(glm.nb(data=hp.endo2,degree ~ sdMaxL)) # positive

# log transform doesn't help
# summary(lm(data=hp.endo2,log(PD) ~ cvmaxL)) # positive
# summary(lm(data=hp.endo2,log(PD) ~ maxMaxL)) # positive
# summary(lm(data=hp.endo2,log(PD) ~ meanMaxL)) # negative
# summary(lm(data=hp.endo2,log(PD) ~ sdMaxL)) # positive
# 
# summary(glm.nb(data=hp.endo2,PS ~ cvmaxL)) # positive
# summary(glm.nb(data=hp.endo2,PS ~ maxMaxL)) # positive
# summary(glm.nb(data=hp.endo2,PS ~ meanMaxL)) # negative
# summary(glm.nb(data=hp.endo2,PS ~ sdMaxL)) # positive

summary(lm(data=hp.endo2,SPD ~ cvmaxL)) # positive
summary(lm(data=hp.endo2,SPD ~ maxMaxL)) # no relationship
summary(lm(data=hp.endo2,SPD ~ meanMaxL)) # negative
summary(lm(data=hp.endo2,SPD ~ sdMaxL)) # positive
```

## Ectoparasites & Host Body Size
Clay's model predicts that for ectoparasites, there should be few generalist parasites of either very small bodied or very large bodied hosts.

This seems to be the case for degree, PD, and PS, but not so clear for SPD. However, I categorized by quartiles and due to the skewed distribution and long tail, in some cases relatively low values for length are in the 4th quartile, for example for sd and max length. Mean length shows what we expect with quartile categorization. Is there a better way to categorize?  

```{r ecto, echo=FALSE,warning=FALSE}
hp.ecto <- generalism.traits %>% filter(Endoparasite =="Ecto")
hp.ecto2 <- hp.ecto %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD)

# divide into quartiles
summean <- summary(hp.ecto2$meanMaxL)
hp.ecto2$mean.lcat <- 1
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["1st Qu."]] <- 2
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["Median"]] <- 3
hp.ecto2$mean.lcat[hp.ecto2$meanMaxL > summean["3rd Qu."]] <- 4

sumsd <- summary(hp.ecto2$sdMaxL)
hp.ecto2$sd.lcat <- 1
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["1st Qu."]] <- 2
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["Median"]] <- 3
hp.ecto2$sd.lcat[hp.ecto2$sdMaxL > sumsd["3rd Qu."]] <- 4

summax <- summary(hp.ecto2$maxMaxL)
hp.ecto2$max.lcat <- 1
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["1st Qu."]] <- 2
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["Median"]] <- 3
hp.ecto2$max.lcat[hp.ecto2$maxMaxL > summax["3rd Qu."]] <- 4

sumcv <- summary(hp.ecto2$cvmaxL)
hp.ecto2$cv.lcat <- 1
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["1st Qu."]] <- 2
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["Median"]] <- 3
hp.ecto2$cv.lcat[hp.ecto2$cvmaxL > sumcv["3rd Qu."]] <- 4

ectoDlong <- hp.ecto2 %>% gather("index","value",4:7)
ectoDlong1 <- ectoDlong %>% gather("length_cat_measure","length_cat",c(13:16))
ectoDlong2 <- ectoDlong1 %>% gather("length_measure","length",9:12)


ectoDlong2 %>%  ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="lm")

# ectoDlong2 %>%  ggplot(data=.,aes(x=length,y=value)) + geom_jitter() + theme_bw() + facet_grid(index~length_measure,scales="free") + ylab("index value") + geom_smooth(method="loess")

ectoDlong2 %>% ggplot(data=.,aes(x=as.factor(length_cat),y=value)) + geom_boxplot() + theme_bw() + facet_grid(index~length_cat_measure,scales="free") + ylab("index value")

```



```{r ectoanalysis, echo=FALSE,eval=FALSE}
# Negative binomial GLM seems like the best way to compare Ecto degree to quartiles of length categories. The estimates are log values, so exp() to get the estimate. Except, it's strictly positive so should use a zero truncated model?
summary(lm(data=hp.ecto2,cvmaxL~SPD))

summary(lm(data=hp.ectoDirect,maxMaxL~SPD))
summary(lm(data=hp.ectoDirect,maxMaxL~VarSPD))

summary(lm(data=hp.ectoDirect,meanMaxL~SPD))
summary(lm(data=hp.ectoDirect,meanMaxL~VarSPD))

summary(lm(data=hp.ectoDirect,sdMaxL~SPD))
summary(lm(data=hp.ectoDirect,sdMaxL~VarSPD))

# these LMs don't have straight Q-Q plots. Need to think about the implications.

library(MASS)
summary(glm.nb(data=hp.ectoDirect,degree ~ cvmaxL))
summary(glm.nb(data=hp.ectoDirect,degree ~ maxMaxL))
summary(glm.nb(data=hp.ectoDirect,degree ~ meanMaxL))
summary(glm.nb(data=hp.ecto2,degree ~ as.factor(mean.lcat)))

```

## Temperature (Region) and Generalism
Clay's model predicts that generalists are more likely in cooler temperatures. Our measure of temperature based on region here is very, very rough. We see higher degree in cool regions, but slightly lower phylogenetic generalism. Could this be because of confounding with available hosts and higher host diversity in warm regions?


```{r geo, echo=FALSE,warning=FALSE}
# Use alternative index calculated with GEO
load("~/dat/generalismtheory/indices29maytraits_GEO.RData")
names(generalism.traits.GEO)[5:9] <- c("PS","SPD","sSPD","PD","degree")
generalism.traits.GEO$cvmaxL <- generalism.traits.GEO$sdMaxL/generalism.traits.GEO$meanMaxL

hp.geoDirect <- generalism.traits.GEO %>% filter(Trophic=="Yes" | Complex=="No") %>% dplyr::select(-sSPD)

GeoDirectEcto <- hp.geoDirect #%>% filter(Endoparasite=="Ecto")
GeoDirectEcto$GeoGroup <- NA
GeoDirectEcto$GeoGroup[GeoDirectEcto$GEO %in% c("AFR","AUS","IND","NEO")] <- "warm"
GeoDirectEcto$GeoGroup[GeoDirectEcto$GEO %in% c("ANT","NEA","PAL")] <- "cool"

geoDlong <- GeoDirectEcto %>% gather("index","value",5:8)
geoDlong %>% ggplot(data=.,aes(x=GEO,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free") 
geoDlong %>% ggplot(data=.,aes(x=GeoGroup,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free")

```




```{r geoanalysis, echo=FALSE,eval=FALSE}
summary(lm(data=GeoDirectEcto,SPD ~ GEO))

summary(glm.nb(data=GeoDirectEcto,degree ~ GEO))

summary(glm.nb(data=GeoDirectEcto,degree ~ GeoGroup))

summary(lm(data=GeoDirectEcto,SPD ~ GeoGroup))
summary(lm(data=GeoDirectEcto,PD ~ GeoGroup))

```

## Trophic Transmission
Amy  H's model predicts that parasites with trophic transmission are less likely to be generalists, but we see the opposite pattern in this data.

```{r trophic,echo=FALSE,warning=FALSE}
hp.trop <- generalism.traits %>% filter(Trophic == "Yes" | Trophic=="No") %>% dplyr::select(-sSPD)
troplong <- hp.trop %>% gather("index","value",4:7) 

troplong %>% ggplot(data=.,aes(x=Trophic,y=value)) + geom_boxplot() + theme_bw() + facet_wrap(~index,scales="free") 
```

```{r trophicanalysis, echo=FALSE,eval=FALSE}
summary(glm.nb(data=hp.trop,degree ~ Trophic)) # trophic higher - opposite of model predieciton
summary(lm(data=hp.trop,SPD ~ Trophic))

with(hp.def,table(Trophic,Complex))
# Trophic and Complex are almost perfectly correlated in this subset of the dataset.

```
